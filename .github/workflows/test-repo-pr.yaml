name: Test Repo PR

on:
  pull_request:
    branches: [ main ]

jobs:
  test-docker:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: pmoscode/excalidraw
      DOCKERFILE: Dockerfile

    steps:
      - name: Checkout PR with submodules
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build Docker image
        run: |
          echo "ğŸ³ Building Docker image for test..."
          docker build -f "$DOCKERFILE" -t "${IMAGE_NAME}:test" .

      - name: Run container for basic test
        run: |
          echo "ğŸš€ Starting container for smoke test..."
          docker run -d --name wrapper-test "${IMAGE_NAME}:test"
          
          sleep 5
          
          echo "ğŸ” Checking running state..."
          docker ps --filter "name=wrapper-test"
          
          echo "ğŸ“‹ Logs (last 20 lines):"
          docker logs --tail 20 wrapper-test || true
          
          echo "â€¼ï¸Run healthcheck"
          docker exec wrapper-test wget http://localhost
          
          echo "ğŸ§¹ Cleanup..."
          docker stop wrapper-test || true
          docker rm wrapper-test || true
